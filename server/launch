#!/bin/bash
# argument: cable number starting at 0

# make sure there is at least one tmp directory so ls will not fail
mkdir -p syn/tmp.0

while : ; do # infinite loop
  # get a directory to work on
  while ! d=$(curl -s lad:2525); do sleep 5; done
  if [[ $d = *[![:space:]]* ]]; then
    cd $d
    if test -f top.sv; then
       echo "sintesizing " $d
       if CABLE=$(expr $1 + 1) make > qq.log ; then
           timeout 300 quartus_stp -t /labarc/util/qr.tcl $1 > /dev/null 2>> qq.log
       fi
    else
       echo "configuring in " $d
       /usr/local/bin/jtagcheck
       if jtagconfig | grep --quiet SoC; then
         p=RISCV_SOC
       else
         p=RISCV
       fi
       if quartus_pgm -c$(expr $1 + 1) /labarc/RISCV/$p.cdf | egrep --line-buffered "(Error|Running|successful)" > qq.log ; then
           if test -f *.101; then
              tail -1 inst.101 > top.sv 2>>/dev/null
              if quartus_stp -t /labarc/util/inst.tcl *.101 $1 | egrep --line-buffered "(Error|Running|successful)" >> qq.log ; then
                timeout 300 quartus_stp -t /labarc/util/qr.tcl $1 > /dev/null 2>> qq.log
              fi		   
	   else
              # top.sv does not exist, but create it only to put uploaded IP into it
              if test -f *.zip; then
                 tail -1 *.zip > top.sv 2>>/dev/null
	      elif test -f *.s; then
                 tail -1 *.s > top.sv 2>>/dev/null
	      elif test -f *.c; then
                 tail -1 *.c > top.sv 2>>/dev/null
	      fi
              if make inst.objdump >> qq.log && quartus_stp -t /labarc/util/inst.tcl inst.objdump $1 | egrep --line-buffered "(Error|Running|successful)" >> qq.log ; then
                timeout 300 quartus_stp -t /labarc/util/qr.tcl $1 > /dev/null 2>> qq.log
              fi		   
           fi 
       fi
    fi
    echo "___________________pronto____________________" >> qq.log
    cd
  else
    sleep 5
  fi
done
